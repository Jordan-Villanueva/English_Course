<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Curso de Inglés Básico</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #login-btn, #logout-btn { 
      padding: 10px 20px; 
      margin: 10px; 
      background-color: #0077cc; 
      color: white; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
    }
  </style>
</head>
<body>
  <header>
    <h1>Curso de Inglés Básico</h1>
    <p class="subtitle">Aprende paso a paso desde cero</p>
    <div>
      <button id="login-btn">Iniciar sesión</button>
      <button id="logout-btn" style="display:none;">Cerrar sesión</button>
    </div>
  </header>

  <main id="content">
    <p>Por favor, inicia sesión para acceder al curso.</p>
  </main>

  <footer>
    <p>Curso de Inglés Básico — Creado por Jordan</p>
  </footer>

  <script>
    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const content = document.getElementById("content");

    // URL de Auth0
    const AUTH0_DOMAIN = "dev-bjoqtux6wua5w2l2.us.auth0.com";
    const AUTH0_CLIENT_ID = "ZcgIAj7vMvtUixpX421Jv6gs4YrakeC7";
    const REDIRECT_URI = window.location.origin;

    // Función para iniciar sesión
    loginBtn.onclick = () => {
      const authUrl = `https://${AUTH0_DOMAIN}/authorize?response_type=token&client_id=${AUTH0_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&scope=openid%20email%20profile`;
      window.location.href = authUrl;
    };

    // Función para cerrar sesión
    logoutBtn.onclick = () => {
      localStorage.removeItem("access_token");
      content.innerHTML = "<p>Por favor, inicia sesión para acceder al curso.</p>";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    };

    // Función para leer hash de URL después del login
    function parseHash() {
      if (window.location.hash) {
        const hash = window.location.hash.substr(1).split("&").reduce((res, item) => {
          const parts = item.split("=");
          res[parts[0]] = parts[1];
          return res;
        }, {});
        if (hash.access_token) {
          localStorage.setItem("access_token", hash.access_token);
          window.location.hash = "";
        }
      }
    }

    async function checkUser() {
      const token = localStorage.getItem("access_token");
      if (!token) return;

      // Llamada a Netlify Function que valida si el usuario está autorizado
      const res = await fetch("/.netlify/functions/check-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });

      const data = await res.json();

      if (data.authorized) {
        content.innerHTML = `
          <section>
            <h2>Clases disponibles</h2>
            <ul>
              <li><a href="Class1/index.html">Clase 1: Presentaciones, saludos y despedidas</a></li>
              <li><a href="Class2/index.html">Clase 2: (próximamente)</a></li>
            </ul>
          </section>
        `;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
      } else {
        content.innerHTML = "<h2>Acceso denegado</h2>";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
      }
    }

    parseHash();
    checkUser();
  </script>
</body>
</html>
